<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>üé≤ T√†i X·ªâu 3D Casino Demo</title>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; background:#0b0b0b; color:#fff;}
.ui { position:absolute; top:10px; left:10px; z-index:10; }
.ui input, .ui button { margin:5px; padding:8px; border-radius:4px; border:none; }
.balance { font-weight:bold; margin-top:10px;}
.history { max-height:150px; overflow-y:auto; margin-top:10px; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px;}
</style>
</head>
<body>
<div class="ui">
  <div id="loginSection">
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="register()">ƒêƒÉng k√Ω</button>
    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
    <div id="loginMsg"></div>
  </div>
  <div id="gameUI" style="display:none;">
    <div class="balance">S·ªë d∆∞: <span id="balance">0</span> ‚Ç´</div>
    <div>C∆∞·ª£c: <input type="number" id="betAmount" value="100" min="1"> ‚Ç´</div>
    <button onclick="placeBet('T√†i')">T√†i</button>
    <button onclick="placeBet('X·ªâu')">X·ªâu</button>
    <button onclick="rollDice()">Quay x√∫c x·∫Øc</button>
    <div>K·∫øt qu·∫£: <span id="result">-</span></div>
    <div class="history" id="history"></div>
  </div>
</div>

<audio id="soundDice" src="https://www.myinstants.com/media/sounds/dice.mp3"></audio>
<audio id="soundCup" src="https://www.myinstants.com/media/sounds/cup.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/TextureLoader.js"></script>

<script>
// ======== USER SYSTEM =========
let currentUser=null;
const usersKey="tx_demo_users";
function getUsers(){ return JSON.parse(localStorage.getItem(usersKey)||'{}'); }
function saveUsers(users){ localStorage.setItem(usersKey,JSON.stringify(users)); }
function hashPassword(pw){ return btoa(pw); }

function register(){
  const name=document.getElementById('username').value.trim();
  const pw=document.getElementById('password').value;
  if(!name||!pw){ alert("Nh·∫≠p ƒë·ªß th√¥ng tin"); return; }
  let users=getUsers();
  if(users[name]){ alert("User ƒë√£ t·ªìn t·∫°i"); return; }
  users[name]={pw:hashPassword(pw), balance:1000, history:[]};
  saveUsers(users); alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
}
function login(){
  const name=document.getElementById('username').value.trim();
  const pw=document.getElementById('password').value;
  let users=getUsers();
  if(!users[name]||users[name].pw!==hashPassword(pw)){ alert("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u"); return; }
  currentUser=name;
  document.getElementById('loginSection').style.display='none';
  document.getElementById('gameUI').style.display='block';
  updateBalance(); renderHistory();
}

// ======== GAME LOGIC =========
let currentBet=null;
let autoRollInterval=null;
function updateBalance(){ const users=getUsers(); document.getElementById('balance').innerText=users[currentUser].balance; }
function renderHistory(){
  const users=getUsers();
  const histEl=document.getElementById('history');
  histEl.innerHTML="";
  users[currentUser].history.slice().reverse().forEach(h=>{
    const div=document.createElement('div');
    div.textContent=`C∆∞·ª£c: ${h.bet} ${h.amount} ‚Ç´, KQ: ${h.result}, T·ªïng: ${h.total}, Th·∫Øng: ${h.win} ‚Ç´`;
    histEl.appendChild(div);
  });
}
function placeBet(choice){ currentBet=choice; alert("ƒê·∫∑t c∆∞·ª£c: "+choice); }

// ======== THREE.JS 3D SCENE =========
let scene,camera,renderer,controls;
let diceMeshes=[],cupMesh,diceTextures=[];
initThree(); animate();

function initThree(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0b0b0b);
  camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,5,8);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.enablePan=false; controls.enableZoom=true;

  // lights
  const ambient=new THREE.AmbientLight(0xffffff,0.6);
  scene.add(ambient);
  const spot=new THREE.SpotLight(0xffddaa,1);
  spot.position.set(5,10,5); spot.castShadow=true;
  scene.add(spot);

  // floor (b√†n casino)
  const floorMat=new THREE.MeshStandardMaterial({color:0x552200});
  const floorGeo=new THREE.PlaneGeometry(20,20);
  const floor=new THREE.Mesh(floorGeo,floorMat); floor.rotation.x=-Math.PI/2; scene.add(floor);

  // cup 3D
  const cupGeo=new THREE.CylinderGeometry(1.5,1.5,1,32,true);
  const cupMat=new THREE.MeshStandardMaterial({color:0x660000, side:THREE.DoubleSide, transparent:true, opacity:0.8});
  cupMesh=new THREE.Mesh(cupGeo,cupMat); cupMesh.position.y=1; scene.add(cupMesh);

  // dice textures
  const loader=new THREE.TextureLoader();
  for(let i=1;i<=6;i++){
    diceTextures.push(loader.load(`https://i.imgur.com/${[1,2,3,4,5,6][i-1]}.png`)); // placeholder
  }

  // dice
  const diceGeo=new THREE.BoxGeometry(1,1,1);
  for(let i=0;i<3;i++){
    const materials=[
      new THREE.MeshStandardMaterial({map:diceTextures[0]}),
      new THREE.MeshStandardMaterial({map:diceTextures[1]}),
      new THREE.MeshStandardMaterial({map:diceTextures[2]}),
      new THREE.MeshStandardMaterial({map:diceTextures[3]}),
      new THREE.MeshStandardMaterial({map:diceTextures[4]}),
      new THREE.MeshStandardMaterial({map:diceTextures[5]}),
    ];
    const dice=new THREE.Mesh(diceGeo,materials);
    dice.position.set(i-1,0.5,0);
    scene.add(dice); diceMeshes.push(dice);
  }
}

function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }

// ======== DICE ROLL =========
function rollDice(){
  const betAmount=parseInt(document.getElementById('betAmount').value)||100;
  if(!currentBet){ alert("Vui l√≤ng ƒë·∫∑t c∆∞·ª£c"); return; }
  const users=getUsers();
  if(users[currentUser].balance<betAmount){ alert("Kh√¥ng ƒë·ªß s·ªë d∆∞"); return; }

  document.getElementById('result').innerText="-";
  cupMesh.rotation.x=0; document.getElementById('soundCup').play();

  let rolls=[],count=0;
  const interval=setInterval(()=>{
    rolls=[1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6)];
    diceMeshes.forEach((d,i)=>{
      d.rotation.x=Math.random()*10; d.rotation.y=Math.random()*10; d.position.y=0.5+Math.random()*0.2;
    });
    count++; if(count>=20){
      clearInterval(interval);
      setTimeout(()=>{ cupMesh.rotation.x=-Math.PI; showResult(rolls,betAmount); },500);
    }
  },100);
  document.getElementById('soundDice').play();
}

function showResult(rolls,betAmount){
  const total=rolls.reduce((a,b)=>a+b,0);
  let resultText="";
  if(rolls[0]==rolls[1] && rolls[1]==rolls[2]) resultText="Triple - Thua t·∫•t c·∫£";
  else resultText=(total>=11 && total<=17)?"T√†i":"X·ªâu";

  document.getElementById('result').innerText=resultText;

  const users=getUsers();
  let win=0; if(resultText===currentBet) win=betAmount;
  users[currentUser].balance+=win-(win===0?betAmount:0);
  users[currentUser].history.push({bet:currentBet,amount:betAmount,result:resultText,total,win});
  saveUsers(users); updateBalance(); renderHistory();
  currentBet=null;
}

// ======== AUTO ROLL =========
function startAutoRoll(){
  autoRollInterval=setInterval(()=>{
    if(currentUser){
      currentBet=["T√†i","X·ªâu"][Math.floor(Math.random()*2)];
      document.getElementById('betAmount').value=100+Math.floor(Math.random()*400);
      rollDice();
    }
  },30000);
}
startAutoRoll();
window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
</script>
</body>
</html>
